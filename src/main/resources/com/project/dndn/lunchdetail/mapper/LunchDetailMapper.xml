<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.dndn.lunchdetail.mapper.LunchDetailMapper">

	<select id="getLunchBoxDetail" resultType="com.project.dndn.lunchdetail.domain.LunchBoxDTO">

        SELECT sb.sellboardseq, sb.content, sb.sale, sb.regdate, sb.periodic, sb.pic, SUM(l.price) AS price
        FROM tblSellBoard sb
                 INNER JOIN tblLunchBoxSet ls ON sb.sellboardseq = ls.sellboardseq
                 INNER JOIN tblLunchbox l ON ls.lunchboxseq = l.lunchboxseq
        where PERIODIC = #{period} and sb.sellboardseq = #{seq}
        GROUP BY sb.sellboardseq, sb.content, sb.sale, sb.regdate, sb.periodic, sb.pic

    </select>

    <select id="lunchBoxDetailList" resultType="String">
        select pic as detail
        from tblLunchBoxDetailPic
        where sellboardseq = #{seq}
    </select>

    <select id="getStoreLocations" resultType="com.project.dndn.lunchdetail.domain.StoreLocationDTO">
        select * from tblStore
    </select>

    <select id="readUserWishList" resultType="int">
        select count(*) from tblWishList where id = #{id} and sellboardseq = #{sellboardseq}
    </select>

    <delete id="deleteUserWishList">
        delete from tblWishList where id = #{id} and sellboardseq = #{sellboardseq}
    </delete>

    <insert id="insertUserWishList">
        insert into tblWishList values(wishlistseq.nextVal, #{id}, #{sellboardseq}, sysdate)
    </insert>

    <insert id="addCart">
        insert into tblCart values (cartseq.nextVal, #{id}, #{sellboardseq}, null, #{cnt}, #{storeseq}, 'F', sysdate)
    </insert>

    <select id="listCart" resultType="com.project.dndn.lunchdetail.domain.CartDTO">
        select c.*, (select name from tblStore where storeseq=c.storeseq) as storename, (select pic from tblSellBoard where sellboardseq = c.sellboardseq) as pic, (select content from tblSellBoard where sellboardseq = c.sellboardseq) as content, (select sale from tblSellBoard where sellboardseq = c.sellboardseq) as sale, (select price from v_sellboard where sellboardseq = c.sellboardseq) as price  from tblCart c where status = 'F' and id = #{id}
    </select>

    <delete id="delCart">
        delete from tblCart where cartseq in
            <foreach collection="list" item="cartseq" open="(" close=")" separator="," >
                #{cartseq}
            </foreach>
    </delete>

<!--    <select id="orderCart" resultType="com.project.dndn.lunchdetail.domain.CartDTO">-->
<!--        select c.*, (select name from tblStore where storeseq=c.storeseq) as storename, (select pic from tblSellBoard where sellboardseq = c.sellboardseq) as pic, (select content from tblSellBoard where sellboardseq = c.sellboardseq) as content, (select sale from tblSellBoard where sellboardseq = c.sellboardseq) as sale, (select price from v_sellboard where sellboardseq = c.sellboardseq) as price  from tblCart c where status = 'F' and id = #{id} and cartseq =#{cartseq}-->
<!--    </select>-->

    <select id="maxCartseq" resultType="String">
        select max(cartseq) from tblCart where id=#{id}
    </select>

    <!-- 주문하기 페이지에 올라가는 장바구니 쿼리 -->
    <select id="orderCartList" resultType="com.project.dndn.lunchdetail.domain.CartDTO">
        select c.*, (select name from tblStore where storeseq=c.storeseq) as storename, (select pic from tblSellBoard where sellboardseq = c.sellboardseq) as pic, (select content from tblSellBoard where sellboardseq = c.sellboardseq) as content, (select sale from tblSellBoard where sellboardseq = c.sellboardseq) as sale, (select price from v_sellboard where sellboardseq = c.sellboardseq) as price  from tblCart c where status = 'F' and id = #{id} and cartseq IN
        <foreach collection="list" item="cartseq" open="(" close=")" separator="," >
            #{cartseq}
        </foreach>
    </select>

    <select id="getUserCouponList" resultType="com.project.dndn.lunchdetail.domain.CouponDTO">
        select couponmemberseq, id, couponseq, getdate, isuse,
               (select name from tblCoupon where couponseq=cm.couponseq) as name,
               (select sale from tblCoupon where couponseq=cm.couponseq) as sale,
               (select period from tblCoupon where couponseq=cm.couponseq) as period
        from tblCouponMember cm where id=#{id} and isuse='F'
    </select>

    <!-- addressseq.nextVal, id, addressname, tel, zipcode, address, addressdetail -->
    <insert id="insertAddress">
        insert into tblAddress values(addressseq.nextVal, #{id}, #{addressname}, #{tel}, #{zipcode}, #{address}, #{addressdetail})
    </insert>

    <insert id="insertOrder">
        <selectKey resultType="int" keyProperty="addressseq" order="BEFORE">
            select MAX(addressseq) from tblAddress
        </selectKey>

        <if test="couponseq==null">
            insert into tblOrder values(orderseq.nextVal, #{id}, #{price}, sysdate, #{request}, null, #{payment}, 'T', #{addressseq}, null)
        </if>
        <if test="couponseq!=null">
            insert into tblOrder values(orderseq.nextVal, #{id}, #{price}, sysdate, #{request}, #{couponseq}, #{payment}, 'T', #{addressseq}, null)
        </if>

    </insert>

    <update id="updateOrderCart">
        update tblCart set status='T'
        where cartseq IN
        <foreach collection="list" item="cartseq" open="(" close=")" separator="," >
            #{cartseq}
        </foreach>
    </update>

    <update id="updateCoupon">
        update tblCouponMember set isuse = 'T'
        where couponmemberseq = #{couponmemberseq} and id = #{id}
    </update>

    <update id="updateMemberPoint">
        update tblMember set point = point + #{point}
        where id = #{id}
    </update>

    <select id="getUserPoint" resultType="int">
        select point from tblMember where id = #{id}
    </select>

    <insert id="reviewWrite">
        <if test="image!=null">
            insert into tblReview values(reviewseq.nextVal,#{sellboardseq}, sysdate, #{content}, #{star}, #{id},  #{image})
        </if>
        <if test="image==null">
            insert into tblReview values(reviewseq.nextVal,#{sellboardseq}, sysdate, #{content}, #{star}, #{id},  null)
        </if>
    </insert>

	<select id ="listReview" resultType="com.project.dndn.lunchdetail.domain.ReviewDTO">
		select * from tblReview where sellboardseq=#{seq} 
	</select>



</mapper>